language: node_js
node_js:
- stable

addons:
  sonarcloud:
    organization: steinko-github
    token:
      secure: bedd53752066ff9fb6d937ef01e864ac82317bcd

before_install:
- openssl aes-256-cbc -K $encrypted_116c5b5544ce_key -iv $encrypted_116c5b5544ce_iv -in service-account.json.enc -out service-account.json -d
  
  
script:
- npm install
- npm run-script build
- npm test --ci 
- sonar-scanner
- eslint src --fix

deploy:
  provider: gae
  keyfile: appengine-account.json
  project: project45913

after_deploy: 
 - git clone https://github.com/joyent/node.git
 - cd node
 - git checkout v10.15.3
 - ./configure
 - make 
 - sudo make install
 - curl -L https://npmjs.org/install.sh | sudo sh
 - cd ..
 - mkdir  tests
 - cd tests
 - git clone https://github.com/steinko/TodoFunctionalSystemTest.git
 - npm install
 - npm test